---
import Layout from "../../layouts/Layout.astro";
import TablerIcon from "../../components/TablerIcon.astro";
import type { Project } from "../../lib/projects";

interface Tool {
  src: string;
  alt: string;
}

interface Props {
  project: Project;
  tools: readonly Tool[];
  heroImage: string;
  heroAlt?: string;
  heroHasSurface?: boolean;
  overviewHeading: string;
  overviewText: string;
  duration?: string;
  primaryMetaLabel?: string;
  primaryMetaValue?: string;
  projectType: string;
}

const {
  project,
  tools,
  heroImage,
  heroAlt = `Podgląd projektu ${project.title}`,
  heroHasSurface = false,
  overviewHeading,
  overviewText,
  duration,
  primaryMetaLabel = "Czas trwania",
  primaryMetaValue,
  projectType,
} = Astro.props;

const resolvedPrimaryMetaValue = primaryMetaValue ?? duration ?? "";

function getDarkIconSrc(src: string): string | undefined {
  if (src === "/icons/tool-openai.png" || src === "/icons/tool-chatgpt.svg") {
    return "/icons/openai-dark-icon.png";
  }

  if (src === "/icons/tool-vercel.svg") {
    return "/icons/vercel-dark-icon.png";
  }

  return undefined;
}
---

<Layout title={project.title} description={project.description}>
  <section class="px-[32px] pt-[32px] sm:px-10 sm:pt-[36px] lg:px-16 lg:pt-[40px]" aria-label="Separator sekcji projektu">
    <div class="mx-auto flex min-h-[20px] w-full items-center">
      <div class="h-px w-full border-b border-[var(--color-subtle)]"></div>
    </div>
  </section>

  <article class="mx-auto w-full max-w-[1040px] px-6 pb-[120px] pt-[32px] sm:px-8 sm:pb-[144px] sm:pt-[48px] lg:px-0 lg:pb-[200px] lg:pt-[80px]" aria-labelledby="work-detail-title">
    <div class="sticky top-[32px] z-30 hidden h-0 w-full lg:block">
      <div class="flex justify-end pr-[24px]">
        <a
          href="/work"
          data-case-study-close
          class="flex size-[44px] items-center justify-center rounded-full border border-[var(--color-text)] bg-[var(--color-background)] text-[var(--color-text)] transition-colors hover:bg-[var(--color-foreground)]"
          aria-label="Powrót do listy projektów"
        >
          <TablerIcon name="x" class="size-[24px]" />
        </a>
      </div>
    </div>

    <div class="flex flex-col gap-[80px] sm:gap-[96px] lg:gap-[120px]">
      <header class="mx-auto flex w-full max-w-[864px] flex-col gap-[40px] sm:gap-[48px]">
        <div class="flex flex-col gap-[24px]">
          <h1
            id="work-detail-title"
            class="text-[24px] leading-[32px] text-[var(--color-text)] lg:text-[32px] lg:leading-[44px]"
            transition:name={`work-${project.slug}-title`}
          >
            {project.title}
          </h1>

          <ul class="flex flex-wrap items-center gap-[6px] sm:gap-[12px]" aria-label="Tagi projektu">
            {
              project.tags.map((tag, tagIndex) => (
                <li
                  class="rounded-[5555px] border border-[var(--color-border)] px-[12px] py-[8px] text-[12px] leading-[16px] tracking-[0.25px] text-[var(--color-text)]"
                  transition:name={`work-${project.slug}-tag-${tagIndex}`}
                >
                  {tag}
                </li>
              ))
            }
          </ul>
        </div>

        <div
          class:list={[
            "relative h-auto w-full overflow-hidden sm:h-auto sm:aspect-[108/71] lg:h-[568px]",
            heroHasSurface ? "bg-[var(--color-surface)]" : "bg-[var(--color-background)]",
          ]}
          transition:name={`work-${project.slug}-card`}
        >
          <img
            src={heroImage}
            alt={heroAlt}
            class="w-full h-auto object-contain sm:size-full sm:object-cover"
            transition:name={`work-${project.slug}-image`}
          />
        </div>
      </header>

      <section class="mx-auto grid w-full max-w-[864px] gap-[32px] md:grid-cols-[1fr_220px] md:items-start lg:grid-cols-[598px_215px]" aria-label="Project overview">
        <div class="flex flex-col gap-[24px]">
          <div class="flex flex-col gap-[14px]">
            <p class="text-[12px] uppercase leading-[16px] tracking-[0.4px] text-[var(--color-eyebrow)]">Project overview</p>
            <h2 class="text-[24px] leading-[32px] lg:text-[36px] lg:leading-[44px] text-[var(--color-text)]">{overviewHeading}</h2>
          </div>
          <div class="h-px w-full bg-[var(--color-border)]"></div>
          <p class="text-[14px] lg:text-[16px] leading-[24px] tracking-[0.5px] text-[var(--color-text)]">{overviewText}</p>
        </div>

        <aside class="flex flex-col gap-[20px] md:gap-[16px] lg:gap-[20px]" aria-label="Informacje o projekcie">
          <div class="rounded-[12px] border border-[var(--color-border)] px-[20px] py-[14px] md:px-[16px] md:py-[12px] lg:px-[20px] lg:py-[14px]">
            <div class="flex items-center justify-between gap-[12px] md:flex-col md:items-start md:justify-start">
              <p class="text-[14px] font-medium leading-[20px] tracking-[0.25px] text-[var(--color-text)]">{primaryMetaLabel}</p>
              <p class="text-right text-[14px] leading-[20px] tracking-[0.25px] text-[var(--color-meta)] md:text-left">{resolvedPrimaryMetaValue}</p>
            </div>
          </div>

          <div class="rounded-[12px] border border-[var(--color-border)] px-[20px] py-[14px] md:px-[16px] md:py-[12px] lg:px-[20px] lg:py-[14px]">
            <div class="flex items-center justify-between gap-[12px] md:flex-col md:items-start md:justify-start">
              <p class="text-[14px] font-medium leading-[20px] tracking-[0.25px] text-[var(--color-text)]">Typ projektu</p>
              <p class="text-right text-[14px] leading-[20px] tracking-[0.25px] text-[var(--color-meta)] md:text-left">{projectType}</p>
            </div>
          </div>

          <div class="rounded-[12px] border border-[var(--color-border)] px-[20px] py-[14px] md:px-[16px] md:py-[12px] lg:px-[20px] lg:py-[14px]">
            <div class="flex items-center justify-between gap-[12px] md:flex-col md:items-start md:justify-start">
              <p class="text-[14px] font-medium leading-[20px] tracking-[0.25px] text-[var(--color-text)]">Narzędzia</p>
              <ul class="flex flex-nowrap items-center gap-[12px] lg:gap-[16px]" aria-label="Narzędzia projektu">
                {
                  tools.map((tool) => {
                    const darkIconSrc = getDarkIconSrc(tool.src);

                    return (
                      <li class="inline-flex size-[24px] items-center justify-center">
                        {darkIconSrc ? (
                          <span class="relative inline-flex size-[24px]">
                            <img src={tool.src} alt={tool.alt} class="theme-icon-light size-full object-contain" loading="lazy" />
                            <img src={darkIconSrc} alt={tool.alt} class="theme-icon-dark size-full object-contain" loading="lazy" />
                          </span>
                        ) : (
                          <img src={tool.src} alt={tool.alt} class="size-[24px] object-contain" loading="lazy" />
                        )}
                      </li>
                    );
                  })
                }
              </ul>
            </div>
          </div>
        </aside>
      </section>

      <slot />
    </div>
  </article>
</Layout>

<script is:inline>
  (() => {
    const closeSelector = "[data-case-study-close]";

    const onClick = (event) => {
      const target = event.target;
      if (!(target instanceof Element)) return;

      const closeLink = target.closest(closeSelector);
      if (!(closeLink instanceof HTMLAnchorElement)) return;

      const hasSameOriginReferrer =
        typeof document.referrer === "string" &&
        document.referrer.startsWith(window.location.origin);

      if (window.history.length > 1 && hasSameOriginReferrer) {
        event.preventDefault();
        window.history.back();
      }
    };

    document.addEventListener("click", onClick);
  })();
</script>
